var express = require('express');
var app = express();
var path = require('path');
var bodyParser = require('body-parser');
var mysql = require('mysql');
var LoginService = require("./service/LoginService");
var SigninService = require("./service/SigninService");
var session = require('express-session');
var aepsService = require("./service/AEPSService");
var countAd=0;
var count = 0;

var connection = mysql.createConnection({																		//connect to the MySQL database;
  host: "localhost",
  user: "root",
  password: "root",
  database: "test_schema"
});
connection.connect(function(err) {																				//connect to MySQL database
    if (err) throw err;
    console.log('Connected to database!!')
});

app.use(bodyParser());

app.use(session({
	secret: 'secret',
	resave: true,
	saveUninitialized: true,
	cookie : {
		expires : 60000
	}
}));

app.get('/',function(request,response){														 					// to go to the home page via GET
//	response.sendFile('home2.html',{root : __dirname});
response.sendFile(path.join(__dirname + '/home2.html'));
	console.log("Requested homepage via GET");
});
app.get('/login' , function(request , response){
//	response.sendFile('login2.html',{root : __dirname});
if (request.session.loggedin) {
	response.sendFile(path.join(__dirname + '/fistack.html'));
	console.log("Requested sign in page via GET");
}
 else {  
response.sendFile(path.join(__dirname + '/login2.html'));
	console.log("Requested login page via GET");
 }
});
app.get('/Signin' , function(request , response){
//	response.sendFile('Signin.html',{root : __dirname});
response.sendFile(path.join(__dirname + '/Signin.html'));
	console.log("Requested sign in page via GET");
});

app.get('/home' , function(request , response){
	console.log("Requested sign in page via GET");
	if (request.session.loggedin) {
		response.sendFile(path.join(__dirname + '/fistack.html'));
	}
	 else {  
		response.send('Invalid login. Click here to login!<br><a href="'+'/login'+'">Login</a>');
	}
	});
	
	app.get('/home/AEPS' , function(request , response){
		if (request.session.loggedin) {
			response.sendFile(path.join(__dirname + '/aeps.html'));
			console.log("Requested sign in page via GET");
		}
		 else {  
			response.send('Invalid login. Click here to login!<br><a href="'+'/login'+'">Login</a>');
		}

		console.log("Welcome to aeps page");
		});

		app.post('/transaction/perform', aepsService.performTransaction);

   
		app.get('/home/ENROLLMENT' , function(request, response){
			if (request.session.loggedin) {
				response.sendFile(path.join(__dirname + '/fistack.html'));
				console.log("Requested sign in page via GET");
			}
			 else {  
				response.send('Invalid login. Click here to login!<br><a href="'+'/login'+'">Login</a>');
			}
			response.sendFile(path.join(__dirname + '/onlineform.html'));
			console.log("Welcome to Enrollmnet form");
			});
			app.post('/submit',function(req,res){
				var con = mysql.createConnection({
				  host: "localhost",
				  user: "root",
				  password: "root",
				  database: "test_schema"
				});


				var firstname=req.body.firstname;
				var lastname=req.body.lastname;
				var contactnumber=req.body.contactnumber;
				var Gender=req.body.gender;
				var dateofbirth=req.body.dateofbirth;
				var Address=req.body.address;
				var STATE=req.body.state;
				var PINCODE=req.body.pincode;
				var Nomineename=req.body.nomineename;
				var Nomineerelationship=req.body.nomineerelationship;

				console.log("date : "+dateofbirth);
				console.log("date : "+firstname);
				console.log("date : "+lastname);
				console.log("date : "+contactnumber);
				console.log("date : "+Gender);
				console.log("date : "+dateofbirth);
				console.log("date : "+Address);
			  
				console.log("date : "+STATE);
			  
				console.log("date : "+PINCODE);
			  
				console.log("date : "+Nomineename);
				
				console.log("date : "+Nomineerelationship);

//debug

				res.write('You sent the firstname "' + req.body.firstname+'".\n');
  res.write('You sent the lasttname "' + req.body.lastname+'".\n');
  res.write('You sent the contactnumber "' + req.body.contactnumber+'".\n');
  res.write('You sent the Gender "' + req.body.gender+'".\n');
  res.write('You sent the dateofbirth "' + req.body.dateofbirth+'".\n');
  res.write('You sent the STATE "' + req.body.state+'".\n');
  res.write('You sent the PINCODE "' + req.body.pincode+'".\n');
  res.write('You sent the Nomineename "' + req.body.nomineename+'".\n');
  res.write('You sent the Nomineerelationship "' + req.body.nomineerelationship+'".\n');
  con.connect(function(err) {
	if (err) throw err;
	var sql = "INSERT INTO enrollmentdetails (firstname,lastname,Contactnumber,Gender,dateofbirth,Address,STATE,PINCODE,Nomineename,Nomineerelationship) VALUES ('"+firstname+"', '"+lastname+"','"+contactnumber+"','"+Gender+"','"+dateofbirth+"','"+Address+"','"+STATE+"','"+PINCODE+"','"+Nomineename+"','"+Nomineerelationship+"')";
	con.query(sql, function (err, result) {
	  if (err) throw err;
	  console.log("1 record inserted");
	   res.end();
	  });
  });
  })
		
		
		
		
		
				app.get('/home/LOGOUT' , function(request , response){
				response.sendFile(path.join(__dirname + '/home2.html'));
				console.log("Welcome to Enrollmnet form");
				});

app.post('/loginCheck' ,LoginService.login);

app.get('/logout',function(request,response) {
		request.session.destroy(function(err) {
		if (err){
			console.log(err);
		}
		else
		{
			response.redirect('/login');
		}		
	})
});

app.get('/bankDetails', aepsService.getBankDetails);

	/* function(request,response){
	console.log("Login request");
	console.log(request.body.username);
	console.log(request.body.password);
	var resLogin = function (request){

	var qs = "SELECT COUNT(*) as Records_found FROM custdetails WHERE username=\"" + request.body.username + "\" and password = \"" + request.body.password + "\"";
			var res = connection.query(qs, function (err, result) {
											if (err)
							{throw err;}
						console.log(result);
			countAd = result[0]['Records_found'];				
							console.log('count: ' + countAd);	
    if (countAd=="1"){
        response.redirect("/home");
    }
		else{
            response.redirect("/login");
        }
		response.end();
		});		
						};
	resLogin(request);
		
	
});*/

 
app.post('/signup' , SigninService.signUp);

// function(request,response){
// 	console.log("New signin request");
// 	console.log(request.body.username);
// 	console.log(request.body.password);
// 	console.log(request.body.name);
// 	console.log(request.body.Contact);
	
// var resLogin = function (request){
// var qs = "SELECT COUNT(*) as Records_found FROM custdetails WHERE username=\"" + request.body.username + "\"";
// var res = connection.query(qs, function (err, result) {
// if (err)
// 	{throw err;}
// 	console.log(result);
// 	count = result[0]['Records_found'];				
// console.log('count: ' + count);	
// if (count=="1"){response.writeHead(200 , {"Content-type":"text/html"});response.end('<h1>Username already in use</h1><br>');}
// 	else{ qs = "insert into custdetails(username,fullname,password) values('" + request.body.username + "','" +  request.body.name + "','" + request.body.password + "')";			
//  res = connection.query(qs, function (err, result) {
// 	if (err)
// 				{throw err;}
// 	console.log('Addad a new user');
// 	response.end('Added your details. Now you can go back and login with this new username and password');																				
//             });
//         	}
// 	});

// 			};													   
// 	resLogin(request);
// 	});
                                                
app.listen(1337 , function(){																										//to listen to any particular port
	console.log('Listening at port 1337');
});

















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































